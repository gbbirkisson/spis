{% match media %}
{% when Some with (media) %}
<div id="hx-media-preview" class="media-preview" _="on load add .noscroll to body">
  <div id="hx-media-preview-content" class="media-preview-content" _="
           on touchstart
             set my.swipeAllowed to event.touches.length == 1 and (no window.visualViewport or window.visualViewport.scale == 1)
             if my.swipeAllowed
                set my.startY to event.changedTouches[0].clientY
                set my.swiped to false
                set my.style.transition to 'none'
             end
           end

           on touchmove
             if my.swipeAllowed
                set diff to my.startY - event.changedTouches[0].clientY
                set my.style.transform to 'translateY(' + (diff * -0.3) + 'px)'
             end
           end

           on touchend
             if my.swipeAllowed
               set diff to my.startY - event.changedTouches[0].clientY
               if diff > 120
                 set my.swiped to true
                 trigger click on #next-btn
               else if diff < -120
                 set my.swiped to true
                 trigger click on #prev-btn
               else
                 set my.swiped to false
                 transition *transform to 'translateY(0)' over 200ms
               end
             end
           end

           on click
             if my.swiped halt end
             hide #hx-media-preview with *opacity
             then wait 200ms
             then hide #hx-media-preview with *visibility
             then remove #hx-media-preview-content
             then remove .noscroll from body
           end">
    {% if media.video %}
    <video class="img-preview" autoplay controls>
      <source type="video/mp4" src="{{ media.url }}">
    </video>
    {% else %}
    <img class="img-preview" src="{{ media.url }}">
    {% endif %}
  </div>
  <div class="media-action">
    <!-- Archive button -->
    {% if features.archive_allow %}
    <div class="link" id="del-{{ media.uuid }}" {% if archive_confirm %}
      _='on htmx:afterRequest remove #{"{{ media.uuid }}"}' hx-delete="/hx/preview/{{ media.uuid }}/confirm" {% else %}
      hx-delete="/hx/preview/{{ media.uuid }}" {% endif %} hx-trigger="click, keyup[key=='Delete'] from:body"
      hx-target="#hx-media-preview" hx-swap="outerHTML" role="button" aria-label="Archive image">
      <div class="media-action-button"><i
          class="fa-regular fa-trash-can {% if archive_confirm %}icon-red{% else %}icon-white{% endif %}"></i></div>
    </div>
    {% endif %}

    <!-- Info button -->
    <div class="link" _="on click remove .hidden from #info-dialog" role="button" aria-label="Show info">
      <div class="media-action-button"><i class="fa-solid fa-circle-info icon-white"></i></div>
    </div>

    <!-- Favorite button -->
    {% if features.favorite_allow %}
    <div class="link" _="on htmx:afterRequest toggle between .hidden and .visible on #fav-{{ media.uuid }}"
      hx-put="/hx/preview/{{ media.uuid }}/favorite/{{ !media.favorite }}"
      hx-trigger="click, keyup[key=='Enter'] from:body" hx-target="#hx-media-preview" hx-swap="outerHTML" role="button"
      aria-label="Toggle favorite">
      {% if media.favorite %}
      <div class="media-action-button"><i class="fa-solid fa-heart icon-pink"></i></div>
      {% else %}
      <div class="media-action-button"><i class="fa-regular fa-heart icon-white"></i></div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Prev button -->
    {% match prev %}
    {% when Some with (prev) %}
    <div id="prev-btn" class="link" hx-get="/hx/preview/{{ prev.uuid }}"
      hx-trigger="click, keyup[key=='ArrowUp'] from:body" hx-target="#hx-media-preview" hx-swap="outerHTML"
      role="button" aria-label="Previous image">
      <div class="media-action-button"><i class="fa-solid fa-chevron-up icon-white"></i></div>
    </div>
    {% when None %}
    <div class="media-action-button"></div>
    {% endmatch %}

    <!-- Next button -->
    {% match next %}
    {% when Some with (next) %}
    <div id="next-btn" class="link" hx-get="/hx/preview/{{ next.uuid }}"
      hx-trigger="click, keyup[key=='ArrowDown'] from:body" hx-target="#hx-media-preview" hx-swap="outerHTML"
      role="button" aria-label="Next image">
      <div class="media-action-button"><i class="fa-solid fa-chevron-down icon-white"></i></div>
    </div>
    {% when None %}
    <div class="media-action-button"></div>
    {% endmatch %}

    <!-- Exit button -->
    <div class="link"
      _="on click hide #hx-media-preview with *opacity then wait 200ms then hide #hx-media-preview with *visibility then remove #hx-media-preview-content then remove .noscroll from body"
      role="button" aria-label="Close preview">
      <div class="media-action-button"><i class="fa-solid fa-xmark icon-white"></i></div>
    </div>
  </div>

  <!-- Info Dialog -->
  <div id="info-dialog" class="info-dialog hidden">
    <div class="info-row">
      <span class="info-label">File</span>
      <div class="info-value">{{ media.path }}</div>
    </div>
    <div class="info-row">
      <span class="info-label">Timestamp</span>
      <div class="info-value">{{ media.taken_at }}</div>
    </div>
    <div class="info-row">
      <span class="info-label">UUID</span>
      <div class="info-value">{{ media.uuid }}</div>
    </div>
    <div class="info-row">
      <span class="info-label">Url</span>
      <div class="info-value">{{ media.url }}</div>
    </div>
    <div class="info-row">
      <span class="info-label">Thumbnail</span>
      <div class="info-value">{{ media.thumbnail }}</div>
    </div>
    <div class="info-row" style="display: flex; justify-content: flex-end; margin-top: 10px; margin-bottom: 0;">
      <div class="link" _="on click add .hidden to #info-dialog" role="button" aria-label="Close info">
        <div class="media-action-button">
          <i class="fa-solid fa-xmark icon-white"></i>
        </div>
      </div>
    </div>
  </div>
</div>
{% when None %}
<div id="hx-media-preview"></div>
{% endmatch %}
